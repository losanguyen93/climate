 <!DOCTYPE html>
 <html>
  <head>
    
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="Chart.js"></script>
    <meta charset="utf-8">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript">
     

$(document).ready(function(){
    var data = {
    labels: [],
    datasets: [
        {
            label: "TEMPERATURE",
            fillColor: "rgba(220,220,220,0.2)",
            strokeColor: "rgba(220,220,220,1)",
            pointColor: "rgba(220,220,220,1)",
            pointStrokeColor: "#fff",
            pointHighlightFill: "#fff",
            pointHighlightStroke: "rgba(220,220,220,1)",
            data: []
        },
        {
            label: "HUMIDITY",
            fillColor: "rgba(151,187,205,0.2)",
            strokeColor: "rgba(151,187,205,1)",
            pointColor: "rgba(151,187,205,1)",
            pointStrokeColor: "#fff",
            pointHighlightFill: "#fff",
            pointHighlightStroke: "rgba(151,187,205,1)",
            data: []
        }
    ]
};
              var options = {};
              var ctx = document.getElementById("myChart").getContext("2d");
              var myLineChart = new Chart(ctx).Line(data, options);      

var dataOfTemp = 0;
var ctxPie = $("#Pie_Temp").get(0).getContext("2d");
    var dataPie = [
    {
        value: dataOfTemp,
        color:"#F7464A",
        highlight: "#FF5A5E",
        label: "Temperature now"
    },
    {
        value: 50 - dataOfTemp,
        color: "#46BFBD",
        highlight: "#5AD3D1"
    },
];
var myDoughnutChart = new Chart(ctxPie).Doughnut(dataPie);

var dataOfHum = 0;
var ctxPie_Hum = $("#Pie_Hum").get(0).getContext("2d");
    var dataPie_Hum = [
    {
        value: dataOfHum,
        color:"#F7464A",
        highlight: "#FF5A5E",
        label: "Humidity now"
    },
    {
        value: 100 - dataOfHum,
        color: "#46BFBD",
        highlight: "#5AD3D1"
    },
];
var myDoughnutChart_Hum = new Chart(ctxPie_Hum).Doughnut(dataPie_Hum);


//TEMP__________________________________________________________________
var xmlhttp_Temp = new XMLHttpRequest();
var xmlhttp_Hum = new XMLHttpRequest();
xmlhttp_Temp.open('GET', '/database/TEMP', false);
xmlhttp_Temp.send(null);     
  if(xmlhttp_Temp.status == 200) {                  
    var contTemp = JSON.parse(xmlhttp_Temp.responseText);
    xmlhttp_Hum.open('GET', '/database/HUM', false);
    xmlhttp_Hum.send(null); 
    if(xmlhttp_Hum.status == 200) {
       var  contHum= JSON.parse(xmlhttp_Hum.responseText); 
       for(var i=0; i<39; ++i) {
          var date = (contTemp[i].TS).slice(0,19) + " GTM+0300";
          myLineChart.addData([contTemp[i].TEMP, contHum[i].HUMIDITY], date);
          myLineChart.update();
        }
    }
  }


/*
setInterval(function () {
          $.ajax({
           url:      "/database/ID_MAXofTEMP", //url страницы (action_ajax_form.php)
           type:     "GET", //метод отправки
           dataType: "html", //формат данных
            success: function(response) { //Данные отправлены успешно
              var cont = JSON.parse(response);
                    var date = isoDate(cont[0].TS);
                    myLineChart.addData([cont[0].TEMP], date.slice(0,33));
                    dataOfTemp = cont[0].TEMP;
                    myDoughnutChart.segments[0].value = dataOfTemp;  
                    document.getElementById("demo").innerHTML = "TEMPERATURE =" + dataOfTemp + " C";
                    myDoughnutChart.update();
                    myLineChart.removeData();
                    myLineChart.update();
              }
              });},5000);

*/

setInterval(function () {
  $.when(  
    $.ajax("/database/ID_MAXofTEMP"),
    $.ajax("/database/ID_MAXofHUM")
).then(function(result1, result2) {
    var contTemp_2 = result1[0];
    var contHum_2 = result2[0];
    var date = (contTemp_2[0].TS).slice(0,19) + " GTM+0300";
    myLineChart.addData([contTemp_2[0].TEMP, contHum_2[0].HUMIDITY], date);
    myDoughnutChart.segments[0].value = contTemp_2[0].TEMP;
    myDoughnutChart_Hum.segments[0].value = contHum_2[0].HUMIDITY;   
    document.getElementById("Temp").innerHTML = "TEMPERATURE =" + contTemp_2[0].TEMP + " C";
    document.getElementById("Hum").innerHTML = "HUMIDITY =" + contHum_2[0].HUMIDITY + " %";
     myDoughnutChart.update();
     myDoughnutChart_Hum.update();
     myLineChart.removeData();
     myLineChart.update();
     
});
},10000);


var socket = new WebSocket('ws://diplomexam.mybluemix.net/data');
  socket.onmessage = function(e) {
    var item = JSON.parse(e.data);
    if (item.topic == "light"){
      var SunLight = 255 * Math.pow(item.data,(-10/9));
      console.log(SunLight);
      document.getElementById("lux_light").innerHTML = "LIGHT Sensor =" + SunLight + " lx";
      var persent = Math.ceil((SunLight/750)*100); ;
      console.log(persent);
      document.getElementById("persentLight").innerHTML = persent + " %";
      document.getElementById('ProgressBar').style.width = persent+"%";
      console.log(item.data);
    }
  };
  
var $buttonOn = document.querySelector('#turn-btn-on');
  $buttonOn.onclick = function() {
    socket.send("ok");
  };
var $buttonOff = document.querySelector('#turn-btn-off');
  $buttonOff.onclick = function() {
    socket.send("no");
  };

 });
</script>
  </head>
  <body>
    <div class="container">
      <h1>Control the climate with Bluemix</h1>
      <canvas id="myChart" width="1000" height="800"></canvas>
      <p id ="lux_light" style= "font-size: 250%"></p>
      <div class ="row">
        <div class="progress progress-striped span11">
          <div id="ProgressBar" class="bar" style="width: 0%;"></div>
        </div>
        <div class="span1">
          <p id ="persentLight" style= "font-size: 180%"></p>
        </div>

      </div>
      <div class ="row">
        <div class="span6"><canvas id="Pie_Temp" width="200" height="250"></canvas></div>
        <div class="span6"><canvas id="Pie_Hum" width="200" height="250"></canvas></div>
      </div>
      <div class ="row">
        <div class="span6"><h1 id="Temp"></h1></canvas></div>
        <div class="span6"><h1 id="Hum"></h1></div>
      </div>
      <div class ="row">
        <input class="btn btn-primary btn-large span6" type="button" id="turn-btn-on" value="Turn On">
        <input class="btn btn-primary btn-large span6" type="button" id="turn-btn-off" value="Turn Off"> 
      </div>
     
    </div>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>